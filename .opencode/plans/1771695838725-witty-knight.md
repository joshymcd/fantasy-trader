# Fantasy Stock Market Game - Implementation Plan

## Overview

A fantasy-draft-style game where players draft **companies** instead of athletes. Daily stock price % change = points. Players compete in leagues by assembling and managing a portfolio of 8 companies within budget and tier constraints.

**Existing stack**: TanStack Start, Drizzle ORM (PostgreSQL), Better Auth (email/password), Tailwind CSS, Vite, React 19.

**Key decisions**:

- Market data: **Yahoo Finance** (`yahoo-finance2` npm package) - free, sufficient for MVP
- Draft: **Simple portfolio selection** for MVP - users pick 8 companies within constraints (no real-time snake draft)
- Build order: **Backend first, then UI** - schema + logic + scoring fully working before building pages
- Database: **`db:push` only** - no migration files, push schema changes directly
- Environment: `.env` file will be pre-populated with `DATABASE_URL` etc. - no connection setup needed

---

## Phase 1: Database Schema & Core Types

### Goal

Define all game tables in Drizzle, push to DB, establish shared TypeScript types.

### Schema additions to `src/db/schema.ts`

**Keep existing `todos` table** (demo, remove later). Add:

1. **`seasons`** - Season definitions
   - `id` (uuid, PK), `name`, `market` (LSE default), `startDate`, `endDate`, `tradeDeadlineDate`, `budget` (default 100), `scoringMultiplier` (default 10), `firstDayPenalty` (default 0.5), `maxSwapsPerDay` (1), `maxSwapsPerWeek` (5), `status` (enum: SETUP, ACTIVE, COMPLETED), `createdAt`

2. **`instruments`** - Company universe (tiers frozen per season)
   - `id` (uuid, PK), `seasonId` (FK), `symbol`, `name`, `tier` (integer 1-5), `tierCost` (integer), `marketCap` (decimal, for reference), `exchange` (default LSE)
   - Unique constraint on `(seasonId, symbol)`

3. **`leagues`** - League configuration
   - `id` (uuid, PK), `seasonId` (FK), `name`, `ownershipMode` (enum: UNIQUE, DUPLICATES), `creatorId` (FK to Better Auth user), `status` (enum: DRAFT_PENDING, DRAFTING, ACTIVE, COMPLETED), `createdAt`

4. **`teams`** - User's team in a league
   - `id` (uuid, PK), `leagueId` (FK), `userId` (FK to Better Auth user), `name`, `faabBudget` (integer, default 100), `createdAt`
   - Unique constraint on `(leagueId, userId)`

5. **`roster_moves`** - Append-only transaction log (source of truth)
   - `id` (uuid, PK), `teamId` (FK), `type` (enum: DRAFT, ADD, DROP, TRADE), `symbol`, `effectiveDate` (date), `metadata` (jsonb - faabBid, tradePartnerId, etc.), `createdAt`
   - Index on `(teamId, effectiveDate)`

6. **`price_daily`** - EOD price cache (idempotent upserts)
   - `symbol` + `date` (composite PK), `adjClose` (decimal 18,8), `fetchedAt` (timestamptz)
   - Index on `symbol`

7. **`team_day_scores`** - Derived cache (rebuildable)
   - `teamId` + `date` (composite PK), `points` (decimal 12,4), `breakdown` (jsonb), `computedAt`

8. **`trading_calendar`** - LSE trading days
   - `date` (PK), `isTradingDay` (boolean), `nextTradingDay` (date, nullable), `prevTradingDay` (date, nullable)

9. **`waiver_claims`** - Pending FAAB claims (private leagues)
   - `id` (uuid, PK), `teamId` (FK), `addSymbol`, `dropSymbol`, `faabBid` (integer), `status` (enum: PENDING, WON, LOST, CANCELLED), `effectiveDate`, `createdAt`

Note: Snake draft tables (`draft_state`, `draft_picks`) are deferred to post-MVP. For MVP, draft picks are recorded as `roster_moves` with `type = 'DRAFT'`.

### Files to create/modify

- `src/db/schema.ts` - Add all tables above
- `src/db/relations.ts` - Drizzle relations (leagues -> teams -> rosterMoves, etc.)
- `src/types/game.ts` - Shared TypeScript types/enums for game rules

### Verification

- Run `npm run db:push` to apply schema directly
- Run `npm run db:studio` to inspect tables visually

---

## Phase 2: Trading Calendar & Market Data Service

### Goal

Populate trading calendar, implement on-demand EOD price fetching.

### Trading Calendar

- `src/lib/game/calendar.ts`
  - `populateCalendar(year: number)` - Generate calendar entries for a year (exclude weekends + UK bank holidays)
  - `getNextTradingDay(date: Date): Date`
  - `getPrevTradingDay(date: Date): Date`
  - `isTradingDay(date: Date): boolean`
  - `isMarketOpen(): boolean` - Check if LSE is currently open (8:00-16:30 UK time)
  - Store UK bank holidays as a static array (update yearly)

### Market Data Provider (Yahoo Finance via `yahoo-finance2`)

- `src/lib/game/market-data.ts`
  - `fetchEodPrices(symbol: string, startDate: Date, endDate: Date): Promise<PriceBar[]>`
    - Uses `yahoo-finance2` `historical()` method with `{ period1, period2, interval: '1d' }`
    - LSE symbols use `.L` suffix (e.g., `VOD.L`, `SHEL.L`, `AZN.L`)
    - Returns adjusted close prices
  - `ensurePricesUpTo(symbols: string[], targetDate: Date): Promise<void>`
    - Check last cached date per symbol in `price_daily`
    - Fetch missing ranges from Yahoo Finance
    - Idempotent upsert via `ON CONFLICT DO UPDATE`
  - Rate limiting: sequential fetches with small delay between symbols to avoid throttling
  - Error handling: retry with backoff, skip symbol on persistent failure (scores 0)

### Files to create

- `src/lib/game/calendar.ts`
- `src/lib/game/market-data.ts`
- `src/lib/game/uk-holidays.ts` - Static holiday data

### Dependencies to add

```
yahoo-finance2   - Yahoo Finance market data (free, EOD adjusted close)
date-fns         - Date manipulation
```

### Verification

- Unit test: `calendar.test.ts` - Verify weekend/holiday exclusion, next/prev trading day
- Integration test: Fetch real EOD data for a known symbol (e.g. `VOD.L`), verify upsert idempotency

---

## Phase 3: Scoring Engine (Pure Functions)

### Goal

Implement deterministic scoring as pure functions. This is the heart of the game.

### Holdings Reconstruction

- `src/lib/game/holdings.ts`
  - `getHoldingsAtDate(teamId: string, date: Date): Promise<Map<string, HoldingInfo>>`
    - Query `roster_moves` where `effectiveDate <= date`, ordered chronologically
    - Replay: DRAFT/ADD/TRADE-in -> add to map, DROP/TRADE-out -> remove
    - Returns map of `symbol -> { addedDate, tier, tierCost }`
  - `validateRoster(holdings: Map, seasonConfig: SeasonConfig): ValidationResult`
    - Check: exactly 8 holdings, min 1 per tier, total cost <= budget

### Score Calculation

- `src/lib/game/scoring.ts`
  - `calculateTeamDay(teamId: string, date: Date, config: ScoringConfig): Promise<DayScore>`
    - Reconstruct holdings at date
    - For each holding: fetch today's and prev day's `adj_close`
    - Compute `dailyReturn = (closeToday - closeYesterday) / closeYesterday`
    - Compute `points = dailyReturn * 100 * K`
    - Apply first-day penalty if `holding.addedDate === date` -> `points *= 0.5`
    - Return `{ points: number, breakdown: Record<string, number> }`
  - `calculateTeamRange(teamId: string, startDate: Date, endDate: Date): Promise<DayScore[]>`
    - Calculate for each trading day in range
  - `getOrCalculateScore(teamId: string, date: Date): Promise<DayScore>`
    - Check `team_day_scores` cache first
    - If missing, calculate and cache
    - Idempotent upsert

### Score Invalidation

- `invalidateScores(teamId?: string, fromDate?: Date): Promise<void>`
  - Delete cached scores (for algorithm changes or data corrections)

### Files to create

- `src/lib/game/holdings.ts`
- `src/lib/game/scoring.ts`
- `src/lib/game/types.ts` - ScoringConfig, DayScore, HoldingInfo types

### Verification

- Unit tests with mock data: known price movements -> expected points
- Test first-day penalty applies correctly
- Test cache hit/miss behavior
- Test full recalculation after cache invalidation

---

## Phase 4: Season & Instrument Setup

### Goal

Allow admin/creator to set up a season with a universe of companies and their tier assignments.

### Server Functions

- `src/lib/game/season.ts`
  - `createSeason(params)` - Create a new season with config
  - `populateUniverse(seasonId, market)` - Fetch top N companies from exchange, compute tiers
    - Fetch market cap data from provider
    - Sort by market cap, split into quintiles
    - Assign tier costs (20/16/12/8/4)
    - Insert into `instruments`
  - `getSeasonInstruments(seasonId)` - List all instruments with tiers
  - `activateSeason(seasonId)` - Lock tiers, start scoring

### Routes/Pages

- `src/routes/admin/seasons.tsx` - Season management (create, configure, populate)
- Later: could be part of league creation flow

### Verification

- Create a test season, populate with LSE instruments
- Verify tier distribution is roughly equal quintiles
- Verify tier costs are correct

---

## Phase 5: League & Team Management

### Goal

Users can create/join leagues, form teams.

### Server Functions

- `src/lib/game/league.ts`
  - `createLeague(params: { seasonId, name, ownershipMode, creatorId })` - Create league
  - `joinLeague(leagueId, userId, teamName)` - Create team in league
  - `getLeague(leagueId)` - League details + teams
  - `getMyLeagues(userId)` - User's leagues
  - `getLeagueStandings(leagueId)` - Current standings (sum of cached day scores)

### Routes/Pages

- `src/routes/leagues/index.tsx` - My leagues list
- `src/routes/leagues/create.tsx` - Create new league
- `src/routes/leagues/$leagueId.tsx` - League detail/dashboard
- `src/routes/leagues/$leagueId/join.tsx` - Join league (invite link)

### Auth Integration

- Use existing Better Auth session to identify users
- Add auth middleware/guard to game routes
- `src/lib/game/auth.ts` - Helper to get current user from TanStack Start request

### Verification

- Create league, join with multiple test users
- Verify unique constraint on (leagueId, userId)
- Verify league standings calculation

---

## Phase 6: Draft System

### Goal

Implement portfolio selection for both league types.

### Portfolio Selection (MVP - Both League Types)

- `src/lib/game/draft.ts`
  - `selectPortfolio(teamId, symbols: string[])` - Validate and record initial portfolio
    - Validate exactly 8 symbols
    - Validate min 1 from each tier
    - Validate total tier cost <= budget
    - For private unique leagues: validate no symbol already taken by another team
    - Insert 8 `roster_moves` with type=DRAFT, effectiveDate=season start
    - Transition league status from DRAFT_PENDING to ACTIVE once all teams have selected
  - `getAvailableInstruments(leagueId)` - List instruments available for selection
    - All instruments for the season
    - In unique leagues: exclude those already drafted by other teams
  - `validatePortfolio(symbols: string[], seasonId: string, leagueId?: string)` - Dry-run validation

### Draft UI

- `src/routes/leagues/$leagueId/draft.tsx` - Portfolio selection page
  - Available instruments list (filterable by tier, searchable by name/symbol)
  - Selected companies list with running tier cost total
  - Constraint indicators (tier minimums met, budget remaining)
  - "Confirm Portfolio" button with validation

### Future Enhancement (Post-MVP)

- Snake draft with real-time pick timer (WebSocket/SSE)
- Auction draft with bidding

### Verification

- Select valid portfolio -> accepted
- Select portfolio missing a tier -> rejected
- Select portfolio over budget -> rejected
- In unique league: select already-taken symbol -> rejected

---

## Phase 7: Swap/Trade System

### Goal

Mid-season roster changes with all rules enforced.

### Swap System

- `src/lib/game/swaps.ts`
  - `submitSwap(teamId, dropSymbol, addSymbol, faabBid?)`
    - Validate: market closed, daily/weekly limits not exceeded
    - Validate: post-swap roster meets constraints
    - For private unique leagues: create `waiver_claims` entry
    - For global: directly insert `roster_moves` (DROP + ADD), effective next trading day
  - `processWaiverClaims(leagueId, date)`
    - Group claims by `addSymbol`
    - Contested: highest FAAB wins, tie-break by reverse standings
    - Winner: insert roster_moves, deduct FAAB
    - Losers: mark claim as LOST
  - `getSwapHistory(teamId)` - Transaction log
  - `getRemainingSwaps(teamId, date)` - How many swaps left today/this week

### Trade System (Private Leagues)

- `src/lib/game/trades.ts`
  - `proposeTrade(fromTeamId, toTeamId, offeredSymbols, requestedSymbols)`
  - `acceptTrade(tradeId)` - Validate both rosters post-trade, insert moves
  - `rejectTrade(tradeId)`
  - Enforce trade deadline

### Swap/Trade UI

- `src/routes/leagues/$leagueId/roster.tsx` - Roster management
  - Current holdings with daily performance
  - "Swap" button -> modal to select drop/add
  - Available free agents (filtered, searchable)
  - Pending waiver claims
  - Swap history

### Verification

- Submit swap during market hours -> rejected
- Submit swap with invalid tier result -> rejected
- Submit 2 swaps in one day -> second rejected
- FAAB bidding: two teams bid on same instrument, highest wins
- Trade: both rosters valid post-trade

---

## Phase 8: Dashboard & Leaderboard UI

### Goal

Main game experience - see scores, standings, portfolio performance.

### Data Loading Pattern

Every page loader follows:

1. `await ensurePricesUpTo(yesterday)` - Fetch missing prices
2. `await getOrCalculateScores(...)` - Calculate/cache missing scores
3. Return data to component

### Pages

- `src/routes/dashboard.tsx` - User's home
  - Active leagues overview
  - Today's performance across leagues
  - Quick actions (swap, view standings)

- `src/routes/leagues/$leagueId.tsx` - League dashboard
  - Leaderboard (cumulative points, ranked)
  - Daily scores table
  - Each team's roster + today's performance

- `src/routes/leagues/$leagueId/team/$teamId.tsx` - Team detail
  - Holdings with individual company performance
  - Score history chart (daily points over time)
  - Transaction history

- `src/routes/leagues/$leagueId/standings.tsx` - Full standings
  - Cumulative leaderboard
  - Daily breakdown table
  - Company leaderboard (best/worst performers)

### Components

- `src/components/game/Leaderboard.tsx` - Ranked team list with scores
- `src/components/game/PortfolioTable.tsx` - Holdings with daily change
- `src/components/game/ScoreChart.tsx` - Points over time visualization
- `src/components/game/TierBadge.tsx` - Tier indicator (color-coded)
- `src/components/game/InstrumentCard.tsx` - Company card with price/tier info

### Verification

- Dashboard loads without errors
- Leaderboard correctly ranked by cumulative points
- Price data fetches on first load, cached on subsequent loads
- Score recalculation works after cache clear

---

## Phase 9: Polish & Edge Cases

### Navigation & Layout

- Update `src/components/Header.tsx` - Replace demo links with game navigation
- Update `src/routes/__root.tsx` - Game-appropriate title and meta

### Edge Cases to Handle

- Stock halted / no price data -> 0 points for that day
- Company delisted mid-season -> scores 0, user must swap out
- Friday -> Monday return counted as one day
- User joins mid-season (global league) -> scoring starts from join date
- Empty league (no teams) -> no scoring needed
- Concurrent price fetches -> idempotent upserts handle this

### Error Handling

- Market data API failures -> retry with backoff, show stale data warning
- Invalid swap attempts -> clear error messages in UI
- Auth session expired -> redirect to login

### Performance

- Price fetching: batch requests by symbol, parallelize
- Score calculation: for small leagues (<252 days _ 12 teams _ 8 holdings), inline is fine
- Add DB indexes per schema design

### Remove Demo Content

- Remove `src/routes/demo/` directory
- Remove `todos` table from schema
- Clean up demo references

---

## Key Files Summary

### New directories

```
src/lib/game/          - Core game logic (pure functions + DB operations)
src/components/game/   - Game UI components
src/routes/leagues/    - League-related pages
src/routes/dashboard.tsx
src/routes/admin/      - Admin/setup pages
```

### Core logic files

```
src/db/schema.ts         - Extended with all game tables
src/db/relations.ts      - Drizzle relations
src/lib/game/calendar.ts - Trading calendar
src/lib/game/market-data.ts - EOD price fetching
src/lib/game/holdings.ts - Holdings reconstruction
src/lib/game/scoring.ts  - Score calculation
src/lib/game/season.ts   - Season/instrument setup
src/lib/game/league.ts   - League management
src/lib/game/draft.ts    - Draft orchestration
src/lib/game/swaps.ts    - Swap/waiver system
src/lib/game/trades.ts   - Trade system
src/lib/game/types.ts    - Shared game types
src/lib/game/auth.ts     - Auth helpers for game context
```

### Dependencies to add

```
yahoo-finance2   - Yahoo Finance market data (free, EOD adjusted close)
date-fns         - Date manipulation
```

---

## Implementation Order & Dependencies

```
Phase 1 (Schema)         <- no dependencies
Phase 2 (Calendar+Data)  <- Phase 1
Phase 3 (Scoring)        <- Phase 1, 2
Phase 4 (Season Setup)   <- Phase 1, 2
Phase 5 (Leagues/Teams)  <- Phase 1, 4
Phase 6 (Draft)          <- Phase 5
Phase 7 (Swaps/Trades)   <- Phase 3, 5, 6
Phase 8 (Dashboard UI)   <- Phase 3, 5, 6, 7
Phase 9 (Polish)         <- All phases
```

Phases 2 and 4 can be worked in parallel. Phase 3 depends on price data being available but the pure function logic can be written with mocked data first.

---

## Verification Strategy

After each phase:

1. **Schema**: `db:push` succeeds, tables visible in `db:studio`
2. **Calendar/Data**: Unit tests pass, real API fetch works for test symbol
3. **Scoring**: Unit tests with deterministic mock data produce expected scores
4. **Season**: Can create season, populate universe, verify tier quintiles
5. **Leagues**: Can create/join league, auth guards work
6. **Draft**: Full draft flow completes with valid rosters
7. **Swaps**: All validation rules enforced, FAAB processing correct
8. **Dashboard**: Pages render with real data, scores display correctly
9. **Polish**: No demo content remains, error states handled

End-to-end smoke test: Create season -> Create league -> Draft 8 companies each (2 teams) -> Wait for EOD data -> View leaderboard with calculated scores -> Submit a swap -> Verify next-day scoring reflects the change.
